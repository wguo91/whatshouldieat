/*! tellmewheretoeat 2017-02-12 */
"use strict";function getErrorMsg(){var a=["You have to put in an address.","Bad input, buddy.","Do you want a recommendation or not?","That's not a valid address."];return a[Math.floor(Math.random()*a.length)]}function getDrinkMsg(){var a=["I'm thirsty.","Can I get a drink?"];return a[Math.floor(Math.random()*a.length)]}function getRejectMsg(a){var b=Math.floor(Math.random()*a.length),c=a[b][0].split("("),d=["No, that place is shit.","Skip that place. Next.","No, I hate "+c[0]+".","Not into "+c[0]+"."];return d[Math.floor(Math.random()*d.length)]}function getBizInfo(a){var b,c,d,e=[];const f=3.5,g=5e3,h=100;var i=Math.floor(Math.random()*a.length),j=a[i];return a.splice(i,1),j.review_count>h&&(b=100*Math.floor(j.review_count/100),e.push("This place has over "+b+" reviews on Yelp. Just wow.")),j.rating>f&&e.push("This place has a "+j.rating+" star rating on Yelp. Whoa."),j.distance<g&&(c=(j.distance*metersToMiles).toFixed(2),e.push("You're only "+c+" miles away from this place. Go now.")),0===e.length&&e.push("Wait, nevermind. This place sucks."),d=Math.floor(Math.random()*e.length),{name:j.name,address:j.location.display_address[0],lat:j.location.coordinate.latitude,lng:j.location.coordinate.longitude,categories:j.categories,comments:e[d],url:j.url}}var express=require("express"),router=express.Router(),Yelp=require("yelp"),yelp=new Yelp({consumer_key:process.env.YELP_CONSUMER_KEY,consumer_secret:process.env.YELP_CONSUMER_SECRET,token:process.env.YELP_TOKEN,token_secret:process.env.YELP_TOKEN_SECRET});const apiKey=process.env.GOOGLE_API_KEY,pageTitle="What should I eat?",metersToMiles=621371e-9,limit=15,radiusFilter=1e4;var _bizList=null,_lastSearchTerm=null;router.get("/",function(a,b){_bizList=null,b.render("index",{title:pageTitle,apiKey:apiKey})}),router.post("/request/:type",function(a,b){var c,d,e,f,g=a.body.address,h=a.params.type;null===_bizList||h!==_lastSearchTerm?(f=getErrorMsg(),a.checkBody({address:{notEmpty:!0,errorMessage:f}}),a.getValidationResult().then(function(f){var i=f.array();0!==i.length?b.render("index",{errors:i[0].msg,title:pageTitle,apiKey:apiKey}):yelp.search({term:h,location:g,radius_filter:radiusFilter,limit:limit}).then(function(a){_bizList=a.businesses,c=getBizInfo(_bizList),d=getRejectMsg(c.categories),e=getDrinkMsg(),b.render("map",{bizInfo:c,title:pageTitle,rejectMsg:d,drinkMsg:e,userAddress:g,apiKey:apiKey})}).catch(function(c){a.flash("errors","Not a valid address, buddy."),b.redirect("/")}),_lastSearchTerm=h})):0===_bizList.length?(_bizList=null,a.flash("errors","No more choices. Try a different location."),b.redirect("/")):(c=getBizInfo(_bizList),d=getRejectMsg(c.categories),e=getDrinkMsg(),b.render("map",{bizInfo:c,title:pageTitle,rejectMsg:d,drinkMsg:e,userAddress:g,apiKey:apiKey}))}),module.exports=router;